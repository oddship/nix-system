# Terraform Infrastructure

OpenTofu configuration for Hetzner Cloud + Cloudflare.

## Resources

- **hcloud_server.web**: cpx11 VPS in Nuremberg (~$4/mo)
- **hcloud_firewall.web**: Allows SSH (22), HTTP (80), HTTPS (443)
- **cloudflare_record**: A record for oddship.net, CNAME for www
- **tls_private_key.host_ed25519**: Pre-generated SSH host key for agenix

## nixos-anywhere Integration

Uses the [nixos-anywhere terraform module](https://github.com/nix-community/nixos-anywhere) to:
1. Create Hetzner server with Debian
2. Run nixos-anywhere to install NixOS
3. Inject pre-generated SSH host key via `extra_files_script`
4. Deploy NixOS configuration from flake

## Workflow

The `extra-files.sh` script (generated by terraform) injects the SSH host key during nixos-anywhere installation. This allows agenix to decrypt secrets on first boot.

```
terraform apply
    │
    ├─► Create tls_private_key (SSH host key)
    ├─► Create hcloud_server (Debian)
    ├─► Generate extra-files.sh (injects host key)
    └─► Run nixos-anywhere module
            │
            ├─► Partition disk (disko)
            ├─► Install NixOS
            ├─► Copy host key to /etc/ssh/
            └─► Reboot into NixOS
```

## Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `hcloud_token` | Hetzner API token | (required) |
| `cloudflare_token` | Cloudflare API token | (required) |
| `ssh_public_key_path` | SSH public key for access | `~/.ssh/id_ed25519.pub` |
| `ssh_private_key_path` | SSH private key for install | `~/.ssh/id_ed25519` |
| `debug_logging` | Enable nixos-anywhere debug logs | `true` |

Tokens are provided via environment variables from agenix-encrypted secrets.
